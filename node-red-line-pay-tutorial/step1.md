# LINE Payを使えるショッピングサイトを作成する
まずはLINE Payをを使えるショッピングサイトを作成してみましょう。

今回は架空のブックストアを題材にしていきます。

## フローのコピー
今回使用するフローは以下のJsonになるので、コピーしておきます。

Jsonをクリックするとクリップボードにコピーできます。

```
[{"id":"ff1b5e4d75dae58f","type":"tab","label":"Step1","disabled":false,"info":""},{"id":"1230082e1763329a","type":"http in","z":"ff1b5e4d75dae58f","name":"","url":"/shop","method":"get","upload":false,"swaggerDoc":"","x":180,"y":120,"wires":[["4a8ea28fb7e62a35"]]},{"id":"a4d62518925b645d","type":"http response","z":"ff1b5e4d75dae58f","name":"","statusCode":"","headers":{},"x":670,"y":120,"wires":[]},{"id":"19b746ad0eea18c5","type":"template","z":"ff1b5e4d75dae58f","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n    <script src=\"https://unpkg.com/axios/dist/axios.min.js\"></script>\n</head>\n\n<body>\n    <div class=\"mx-auto\" style=\"width: 500px;\">\n        <h1>Book Store</h1>\n        <b>お一人様1冊まで</b>\n        <table class='table'>\n            <tbody>\n                <tr>\n                    <th><p id='BOOK_01_name'>マンガ</p></th>\n                    <th><button class='btn btn-primary btn-sm' id='BOOK_01_' onClick='addToCart()'>￥100</button></th>\n                    <th><p id='BOOK_02_name'>Node-RED入門</p></th>\n                    <th><button class='btn btn-primary btn-sm' id='BOOK_02_' onClick='addToCart()'>￥100</button></th>\n                </tr>\n                <tr>\n                    <th><p id='BOOK_03_name'>時短レシピ</p></th>\n                    <th><button class='btn btn-primary btn-sm' id='BOOK_03_' onClick='addToCart()'>￥100</button></th>\n                    <th><p id='BOOK_04_name'>小説</p></th>\n                    <th><button class='btn btn-primary btn-sm' id='BOOK_04_' onClick='addToCart()'>￥100</button></th>\n                </tr>\n            </tbody>\n        </table>\n        <div class=\"row\">\n            <div class=\"col text-center\">\n                <a class=\"btn btn-success btn-lg\" href='/checkout/{{payload}}'>支払い</a>\n            </div>\n        </div>\n    </div>\n    <script>\n        function addToCart(e){\n            // 要素IDを取得し、UUIDと合わせてproductIdを作成\n            var event = e || window.event;\n            var elem = event.target || event.srcElement;\n            var elemId = elem.id;\n            var productId = elemId + '{{payload}}';\n            var productName = document.getElementById(elemId + 'name').textContent;\n            console.log(productId);\n\n            // カートに追加\n            axios.post('/add_cart', {\n                'uuid': '{{payload}}',\n                'product_id': productId,\n                'product_name': productName\n              })\n              .then(function (response) {\n                console.log(response);\n                document.getElementById(elemId).setAttribute(\"disabled\", true);\n                alert('追加しました');\n              })\n              .catch(function (error) {\n                console.log(error);\n                alert('エラーが発生しました。');\n              });\n        }\n    </script>\n</body>\n","output":"str","x":500,"y":120,"wires":[["a4d62518925b645d"]]},{"id":"4a8ea28fb7e62a35","type":"uuid","z":"ff1b5e4d75dae58f","uuidVersion":"v1","namespaceType":"","namespace":"","namespaceCustom":"","name":"","field":"payload","fieldType":"msg","x":330,"y":120,"wires":[["19b746ad0eea18c5"]]},{"id":"7d30aa5f57b59c7f","type":"http in","z":"ff1b5e4d75dae58f","name":"","url":"/add_cart","method":"post","upload":false,"swaggerDoc":"","x":200,"y":200,"wires":[["93a5986616cd63dc","21df8688a10c9d41"]]},{"id":"9e8d554704a9d20d","type":"http response","z":"ff1b5e4d75dae58f","name":"","statusCode":"","headers":{},"x":660,"y":200,"wires":[]},{"id":"21df8688a10c9d41","type":"mongodb3 in","z":"ff1b5e4d75dae58f","service":"_ext_","configNode":"ed3ea133b0a45842","name":"cartsコレクションに挿入","collection":"carts","operation":"insert","x":460,"y":200,"wires":[["9e8d554704a9d20d"]]},{"id":"93a5986616cd63dc","type":"debug","z":"ff1b5e4d75dae58f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":450,"y":260,"wires":[]},{"id":"4608c628e8e49d0b","type":"http in","z":"ff1b5e4d75dae58f","name":"","url":"/checkout/:uuid","method":"get","upload":false,"swaggerDoc":"","x":210,"y":340,"wires":[["04fa9f7b8e1c69fc"]]},{"id":"5f8af52c802d5c40","type":"http response","z":"ff1b5e4d75dae58f","name":"","statusCode":"","headers":{},"x":1190,"y":400,"wires":[]},{"id":"be8b6b339dcfcc14","type":"template","z":"ff1b5e4d75dae58f","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n</head>\n\n<body>\n    <div class=\"mx-auto\" style=\"width: 600px;\">\n        <div class=\"row\">\n            <div class=\"col text-center\">\n                <p>支払い金額: {{amount}} 円</p>\n            </div>\n        </div>\n        <div class=\"row\">\n            <div class=\"col text-center\">\n                <a class=\"btn btn-success btn-lg\" href='{{resBody.info.paymentUrl.web}}'>支払いを実行</a>\n            </div>\n        </div>\n    </div>\n</body>\n","output":"str","x":1040,"y":400,"wires":[["5f8af52c802d5c40"]]},{"id":"b993ba9ec1561c23","type":"Request","z":"ff1b5e4d75dae58f","name":"","linepayConfig":"d215391969a5c02d","x":260,"y":400,"wires":[["877a22bf08c28206"]]},{"id":"04fa9f7b8e1c69fc","type":"change","z":"ff1b5e4d75dae58f","name":"","rules":[{"t":"set","p":"payload.uuid","pt":"msg","to":"req.params.uuid","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":340,"wires":[["e86caef0cc23ce26"]]},{"id":"e86caef0cc23ce26","type":"mongodb3 in","z":"ff1b5e4d75dae58f","service":"_ext_","configNode":"ed3ea133b0a45842","name":"cartsコレクションからデータを取得","collection":"carts","operation":"find.toArray","x":730,"y":340,"wires":[["2b9d886b48cbf02e"]]},{"id":"2b9d886b48cbf02e","type":"function","z":"ff1b5e4d75dae58f","name":"Request APIのリクエストパラメータ","func":"var appUrl = 'https://2886795280-1880-jago01.environments.katacoda.com';\nvar uuid = msg.req.query.uuid;\nvar carts = msg.payload;\n\nmsg.amount = 0;\nmsg.payload = {\n    \"amount\" : 0,\n    \"currency\" : \"JPY\",\n    \"orderId\" : `MKSI_S_${uuid}_${new Date().getTime()}`,\n    \"packages\": [\n        {\n            \"id\": \"package-999\",\n            \"amount\": 0,\n            \"name\": \"Book Store\",\n            \"products\": []\n        }\n    ],\n    \"redirectUrls\" : {\n        \"confirmUrl\" : `${appUrl}/confirm`,\n        \"cancelUrl\" : `${appUrl}/cancel`\n    }\n};\n\nfor (var i = 0; i < Object.keys(carts).length; i++) {\n    const cart = carts[i];\n    var product = {\n        \"id\": cart.product_id,\n        \"name\": cart.product_name,\n        \"imageUrl\": \"https://1.bp.blogspot.com/-NB1_zQukC_I/V5XcsfGwiGI/AAAAAAAA8r8/Ozfl90XFQZwOcM28I746-pqlxxEMLYq-wCLcB/s300/book4_red.png\",\n        \"quantity\": 1,\n        \"price\": 100\n    };\n    // 合計金額に加算\n    msg.amount += 100\n    \n    // 商品項目に追加\n    msg.payload.packages[0].products.push(product);\n}\n\n// 合計金額をリクエストパラメータに設定\nmsg.payload.amount = msg.amount;\nmsg.payload.packages[0].amount = msg.amount;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":340,"wires":[["b993ba9ec1561c23"]]},{"id":"d4426de2c8294cc8","type":"http in","z":"ff1b5e4d75dae58f","name":"","url":"/confirm","method":"get","upload":false,"swaggerDoc":"","x":170,"y":480,"wires":[["d16c556595f46ee4"]]},{"id":"c95efd02b033954a","type":"http response","z":"ff1b5e4d75dae58f","name":"","statusCode":"","headers":{},"x":750,"y":540,"wires":[]},{"id":"a6b2d6d40e057d75","type":"Confirm","z":"ff1b5e4d75dae58f","name":"","linepayConfig":"d215391969a5c02d","x":260,"y":540,"wires":[["6fc9b3374464a5ff","b470deffd9acffe4","73a768a5cf87e8de"]]},{"id":"b470deffd9acffe4","type":"template","z":"ff1b5e4d75dae58f","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n</head>\n<body>\n    <div class=\"mx-auto\" style=\"width: 1000px;\">\n        {{#payload.info}}\n            <h1>お買い上げありがとうございます</h1>\n            \n            <div class=\"row\">\n                <p>取引ID: {{payload.info.transactionId}}</p>\n                <p>オーダーID: {{payload.info.orderId}}</p>\n            </div>\n            <div class=\"row\">\n                <div class=\"col text-center\">\n                    <button\n                    type=\"button\"\n                    class=\"btn btn-primary btn-lg\"\n                    onclick=\"window.open('/detail?transactionId={{payload.info.transactionId}}')\">詳細</button>\n                    <button \n                    type=\"button\" \n                    class=\"btn btn-primary btn-lg {{#payload.info.authorizationExpireDate}}disabled{{/payload.info.authorizationExpireDate}}\" \n                    onclick=\"window.open('/refund?transactionId={{payload.info.transactionId}}')\">返金</button>\n                </div>\n            </div>\n        {{/payload.info}}\n        {{^payload.info}}\n            <h1>購入完了できませんでした</h1>\n            {{payload.returnMessage}}\n        {{/payload.info}}\n    </div>\n</body>\n","output":"str","x":520,"y":540,"wires":[["c95efd02b033954a"]]},{"id":"5a71e8ccbb0e4d21","type":"http in","z":"ff1b5e4d75dae58f","name":"","url":"refund","method":"get","upload":false,"swaggerDoc":"","x":170,"y":720,"wires":[["5affcebe16d9584a"]]},{"id":"2072af261e2d24a9","type":"http response","z":"ff1b5e4d75dae58f","name":"","statusCode":"","headers":{},"x":950,"y":720,"wires":[]},{"id":"336773c866446879","type":"template","z":"ff1b5e4d75dae58f","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n</head>\n<body>\n    <div class=\"mx-auto\" style=\"width: 1000px;\">\n        {{#payload.info}}\n            <h1>返金完了しました</h1>\n            <div class=\"row\">\n                <div class=\"col text-center\">\n                    <button type=\"button\" class=\"btn btn-primary btn-lg\" onclick=\"window.open('/detail?transactionId={{payload.info.refundTransactionId}}')\">詳細</button>\n                </div>\n            </div>\n        {{/payload.info}}\n        {{^payload.info}}\n            <h1>返金完了できませんでした</h1>\n            <p>{{payload.returnMessage}}</p>\n        {{/payload.info}}  \n    </div>\n</body>\n   ","output":"str","x":780,"y":720,"wires":[["2072af261e2d24a9"]]},{"id":"961598c0190fa76c","type":"function","z":"ff1b5e4d75dae58f","name":"Detail APIのリクエストパラメータ","func":"msg.transactionId = msg.req.query.transactionId;\nmsg.payload = {\n    orderId: msg.req.query.orderId,\n    fields: msg.req.query.fields\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":780,"wires":[["a1a7228295ae0002"]]},{"id":"6c66e3666d32e2bd","type":"http in","z":"ff1b5e4d75dae58f","name":"","url":"detail","method":"get","upload":false,"swaggerDoc":"","x":180,"y":780,"wires":[["961598c0190fa76c"]]},{"id":"add6bbd64b35db6e","type":"http response","z":"ff1b5e4d75dae58f","name":"","statusCode":"","headers":{},"x":1030,"y":780,"wires":[]},{"id":"5affcebe16d9584a","type":"change","z":"ff1b5e4d75dae58f","name":"","rules":[{"t":"set","p":"transactionId","pt":"msg","to":"req.query.transactionId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":720,"wires":[["4e1784b9ed326c74"]]},{"id":"4e1784b9ed326c74","type":"Refund","z":"ff1b5e4d75dae58f","name":"","linepayConfig":"d215391969a5c02d","x":580,"y":720,"wires":[["336773c866446879"]]},{"id":"a1a7228295ae0002","type":"PaymentDetails","z":"ff1b5e4d75dae58f","name":"","linepayConfig":"d215391969a5c02d","x":680,"y":780,"wires":[["ad86a10681ec14eb"]]},{"id":"ad86a10681ec14eb","type":"template","z":"ff1b5e4d75dae58f","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n</head>\n\n<body>\n    <div class=\"mx-auto\" style=\"width: 1000px;\">\n        {{#payload.info}}\n            <h1>注文詳細</h1>\n            <table class=\"table table-borderless\">\n                <tbody>\n                    <tr>\n                      <td>取引ID</td>\n                      <td>{{payload.info.0.transactionId}}</td>\n                    </tr>\n                    <tr>\n                      <td>取引日時</td>\n                      <td>{{payload.info.0.transactionDate}}</td>\n                    </tr>\n                    <tr>\n                      <td>取引タイプ</td>\n                      <td>{{payload.info.0.transactionType}}</td>\n                    </tr>\n                    <tr>\n                      <td>オーダーID</td>\n                      <td>{{payload.info.0.orderId}}</td>\n                    </tr>\n                    <tr>\n                      <td>商品名</td>\n                      <td>{{payload.info.0.productName}}</td>\n                    </tr>\n                    <tr>\n                      <td>ステータス</td>\n                      <td>{{payload.info.0.payStatus}}</td>\n                    </tr>\n                </tbody>\n            </table>\n        {{/payload.info}}\n        {{^payload.info}}\n            <h1>Error</h1>\n            {{payload.returnMessage}}\n        {{/payload.info}}\n    </div>\n</body>\n","output":"str","x":880,"y":780,"wires":[["add6bbd64b35db6e"]]},{"id":"3e9424fec645814e","type":"mongodb3 in","z":"ff1b5e4d75dae58f","service":"_ext_","configNode":"ed3ea133b0a45842","name":"order_cacheコレクションに挿入","collection":"order_cache","operation":"insert","x":800,"y":400,"wires":[["be8b6b339dcfcc14"]]},{"id":"7b7eeb76640aa21f","type":"mongodb3 in","z":"ff1b5e4d75dae58f","service":"_ext_","configNode":"ed3ea133b0a45842","name":"order_cacheコレクションからデータを取得","collection":"order_cache","operation":"find.toArray","x":770,"y":480,"wires":[["6ac1d10fcf6eb935"]]},{"id":"877a22bf08c28206","type":"function","z":"ff1b5e4d75dae58f","name":"キャッシュに挿入するデータ","func":"msg.resBody = msg.payload;\n// キャッシュに挿入するデータ\n// transactionIdはBigIntのためそのままだと挿入できないのでString型に変換\nmsg.payload = {\n    'transaction_id': String(msg.resBody.info.transactionId),\n    'amount':msg.amount\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":400,"wires":[["3e9424fec645814e"]]},{"id":"d16c556595f46ee4","type":"function","z":"ff1b5e4d75dae58f","name":"キャッシュを取り出すためのQuery","func":"msg.transactionId = msg.req.query.transactionId;\nmsg.payload = {\n    'transaction_id': String(msg.req.query.transactionId),\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":480,"wires":[["7b7eeb76640aa21f"]]},{"id":"6ac1d10fcf6eb935","type":"function","z":"ff1b5e4d75dae58f","name":"Confirm APIのリクエストパラメータ","func":"msg.cache = msg.payload[0];\nmsg.payload = {\n    'amount':msg.payload[0].amount,\n    'currency': 'JPY'\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1130,"y":480,"wires":[["a6b2d6d40e057d75"]]},{"id":"73a768a5cf87e8de","type":"function","z":"ff1b5e4d75dae58f","name":"削除対象のキャッシュのQuery","func":"msg.payload = {\n    'transaction_id': String(msg.payload.info.transactionId)\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":580,"wires":[["93947bd13a341d91"]]},{"id":"fde951778279698a","type":"debug","z":"ff1b5e4d75dae58f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1170,"y":580,"wires":[]},{"id":"93947bd13a341d91","type":"mongodb3 in","z":"ff1b5e4d75dae58f","service":"_ext_","configNode":"ed3ea133b0a45842","name":"order_cacheコレクションからデータを削除","collection":"order_cache","operation":"remove","x":890,"y":580,"wires":[["fde951778279698a"]]},{"id":"6fc9b3374464a5ff","type":"switch","z":"ff1b5e4d75dae58f","name":"cacheにLINE botのユーザーIDがある場合","property":"cache.line_user_id","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":220,"y":600,"wires":[["4cf43cf0b750b877"]]},{"id":"4cf43cf0b750b877","type":"function","z":"ff1b5e4d75dae58f","name":"レシートの作成","func":"var accessToken = \"YOUR_ACCESS_TOKEN\";\n// ヘッダーを設定\nmsg.headers = {};\nmsg.headers[\"Content-Type\"] = \"application/json\";\nmsg.headers[\"Authorization\"] = `Bearer ${accessToken}`;\n\n// 送信するメッセージを定義\nmsg.payload = {\n    \"to\": msg.cache.line_user_id,\n    \"messages\":[\n        {\n            'type': 'flex',\n            'altText': 'レシート',\n            'contents': {\n              \"type\": \"bubble\",\n              \"direction\": \"ltr\",\n              \"body\": {\n                \"type\": \"box\",\n                \"layout\": \"vertical\",\n                \"contents\": [\n                  {\n                    \"type\": \"box\",\n                    \"layout\": \"vertical\",\n                    \"contents\": [\n                      {\n                        \"type\": \"text\",\n                        \"text\": \"RECEIPT\",\n                        \"weight\": \"bold\",\n                        \"color\": \"#1DB446\",\n                        \"contents\": []\n                      },\n                      {\n                        \"type\": \"text\",\n                        \"text\": \"Brown Cafe\",\n                        \"weight\": \"bold\",\n                        \"size\": \"xxl\",\n                        \"align\": \"start\",\n                        \"contents\": []\n                      }\n                    ]\n                  },\n                  {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [\n                      {\n                        \"type\": \"text\",\n                        \"text\": \"お支払い金額\",\n                        \"contents\": []\n                      },\n                      {\n                        \"type\": \"text\",\n                        \"text\": `${msg.cache.amount}`,\n                        \"align\": \"end\",\n                        \"contents\": []\n                      }\n                    ]\n                  },\n                  {\n                    \"type\": \"separator\",\n                    \"margin\": \"lg\"\n                  }\n                ]\n              },\n              \"footer\": {\n                \"type\": \"box\",\n                \"layout\": \"horizontal\",\n                \"contents\": [\n                  {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [\n                      {\n                        \"type\": \"text\",\n                        \"text\": \"取引ID\",\n                        \"size\": \"xs\",\n                        \"color\": \"#C7C7C7FF\",\n                        \"align\": \"start\",\n                        \"contents\": []\n                      },\n                      {\n                        \"type\": \"text\",\n                        \"text\": `¥ ${msg.cache.transaction_id}`,\n                        \"size\": \"xxs\",\n                        \"color\": \"#C7C7C7FF\",\n                        \"align\": \"end\",\n                        \"contents\": []\n                      }\n                    ]\n                  }\n                ]\n              }\n            }\n        }\n    ]\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":640,"wires":[["e4ad7f0d9eac0aaa"]]},{"id":"e4ad7f0d9eac0aaa","type":"http request","z":"ff1b5e4d75dae58f","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"https://api.line.me/v2/bot/message/push","tls":"","persist":false,"proxy":"","authType":"","x":690,"y":640,"wires":[["5d7782198129fc44"]]},{"id":"9b03525f4195be0a","type":"debug","z":"ff1b5e4d75dae58f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1430,"y":640,"wires":[]},{"id":"d5cb787d1cd9c559","type":"mongodb3 in","z":"ff1b5e4d75dae58f","service":"_ext_","configNode":"ed3ea133b0a45842","name":"cafe_botコレクションからデータを削除","collection":"cafe_bot","operation":"remove","x":1180,"y":640,"wires":[["9b03525f4195be0a"]]},{"id":"5d7782198129fc44","type":"function","z":"ff1b5e4d75dae58f","name":"削除対象のQuery","func":"msg.payload = {\n    'line_user_id': msg.cache.line_user_id\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":640,"wires":[["d5cb787d1cd9c559"]]},{"id":"ed3ea133b0a45842","type":"mongodb3","uri":"mongodb://mongodb:27017/shop","name":"","options":"","parallelism":"-1"},{"id":"d215391969a5c02d","type":"linepay-config","name":"test","uri":"https://sandbox-api-pay.line.me","channelId":"","channelSecret":""}]
```{{copy}} 

フローをコピーして、Node-REDのフローエディタの右上のハンバーガーメニューから「読み込み」を選択します。

![import-menu](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/import-menu.png)

以下のようにJsonエディタが表示されるので、先程コピーしたJsonを貼り付けます。貼り付けたら「読み込み」ボタンをクリックします。

![import-flow](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/import-flow.png)

読み込みが完了するとフローエディタ上に`Step1`タブが表示されます。

クリックすると以下のようなフローができています。

![step1-flow](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/step1-flow.png)

## LINE PayのAPI認証情報を入力
続いてLINE Payノードに設定するAPIの認証情報を設定していきます。

右側のメニューから歯車アイコンをクリックして設定ノードの編集画面を開いてLINE PayのAPIの認証情報の設定ノードを開きます。

![linepay-config](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/linepay-config.png)

以下のようにSandboxのAPIのURIは入力されていますが、チャネルIDとチャネルシークレットは入力されていません。

![settings-linepay-config](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/setting-linepay-config.png)

事前に準備したSandboxのAPIの認証情報を以下の項目に入力します。

- Channel ID: LINE Pay APIのチャネルID
- Channel Secret: LINE Pay APIのチャネルシークレット

必要な項目を入力したら、「更新」ボタンをクリックします。

![edit-linepay-config](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/edit-line-pay-config.png)

## Mongo DBのユーザー情報を入力
続いてMongo DBのユーザー情報を設定します。

右側のメニューから歯車アイコンをクリックして設定ノードの編集画面を開いてMongo DBのユーザー情報の設定ノードを開きます。

![setting-mongodb-node](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/setting-mongodb-config.png)

接続先のURIは設定されていますが、ユーザー名とパスワードは設定していません。

![mongo-db-config](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/mongo-db-config.png)

ユーザー名とパスワードは以下を設定しているので、それぞれコピペして入力します。

- ユーザー名： `nodered`{{copy}}
- パスワード： `nodered`{{copy}}

入力したら、「更新」ボタンをクリックします。

![edit-mongo-db-config](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/edit-mongo-db-config.png)

## リクエストパラメータを設定
今度はRequest APIに必要なリクエストパラメータを設定します。

functionノードの中で `Request APIのリクエストパラメータ`をダブルクリックします。

![function-request-api](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/function-request-api.png)

ダブルクリックしたときに表示されるコードエディタ画面の1行目にある `appUrl`の値を今起動しているNode-REDのURLに変更します。

改めてになりますが、Node-REDのURLは以下のものになるので、右側のクリップボードアイコンをクリックしてURLをコピーして書き換えても大丈夫です。

`https://[[HOST_SUBDOMAIN]]-1880-[[KATACODA_HOST]].environments.katacoda.com`{{copy}}

![code-edit-step1](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/code-edit-step1.png)

ここまでできたら最後に右上の「デプロイ」ボタンをクリックして変更内容を保存します。

![deploy-button](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/deploy-button.png)

## 動作確認
それでは動作確認をしてみます。

以下のリンクをクリックすると、アプリを起動することができます。

https://[[HOST_SUBDOMAIN]]-1880-[[KATACODA_HOST]].environments.katacoda.com/shop

URLを開くとこのようにシンプルなショッピングサイトが表示されます。

![book-store](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/book-store.png)

試しに金額の書かれたボタンをクリックされると商品がカートに追加された状態になります。

好きな商品を選択したら、支払いをクリックすると決済の確認画面に遷移します。

このとき、Request APIが実行されて決済URLが「支払いを実行」ボタンに仕込まれている状態になるのでクリックしてLINE Payで決済を実行します。

![payment-button](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/payment-button.png)

決済を行う前にLINEアカウントにログインする必要があるので、メールアドレス・パスワードを入力するか、LINEアプリのQRコードからログインしてみましょう。

![line-login](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/line-login.png)

LINE アカウントでログインすると以下のように決済画面が表示されます。「PAY NOW」ボタンをクリックすると決済が実行されます。

![pay-now](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/pay-now.png)

「決済が完了しました」と表示されたら決済画面は閉じて大丈夫です。

先程のショッピングサイトのページに戻ると以下のように決済完了画面が表示されます。

決済の詳細を確認できたり、返金をできたりするので試してみましょう。

![payment-complete](https://raw.githubusercontent.com/Miura55/katacoda-text/main/node-red-line-pay-tutorial/imgs/payment-complete.png)

Step1はこれで終わりです。次はLINE PayにちなんでLINE botからLINE Payを使えるようにするサンプルを紹介します。
